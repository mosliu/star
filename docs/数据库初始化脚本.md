# æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

## æ¦‚è¿°

æœ¬æ–‡æ¡£åŒ…å«æ˜Ÿæ˜Ÿå­˜æŠ˜ç³»ç»Ÿçš„å®Œæ•´æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ–°è¡¨çš„åˆ›å»ºè¯­å¥ã€åˆå§‹ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºã€ä»¥åŠç¤ºä¾‹æ•°æ®æ’å…¥ã€‚

## æ‰§è¡Œé¡ºåº

è¯·æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡ŒSQLè¯­å¥ï¼š
1. åˆ›å»ºåŸºç¡€è¡¨
2. åˆ›å»ºå…³è”è¡¨
3. åˆ›å»ºç´¢å¼•
4. æ’å…¥åˆå§‹æ•°æ®

## 1. åˆ›å»ºç”¨æˆ·ç›¸å…³è¡¨

### 1.1 åˆ›å»ºusersè¡¨ï¼ˆç”¨æˆ·è¡¨ï¼‰
```sql
-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('child', 'parent', 'admin') NOT NULL DEFAULT 'parent',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_verified BOOLEAN NOT NULL DEFAULT FALSE,
    last_login DATETIME,
    login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until DATETIME,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 1.2 æ›´æ–°childrenè¡¨ï¼ˆæ·»åŠ PINç å­—æ®µï¼‰
```sql
-- ä¸ºchildrenè¡¨æ·»åŠ PINç å’Œå…³è”ç”¨æˆ·å­—æ®µ
ALTER TABLE children 
ADD COLUMN IF NOT EXISTS pin_code VARCHAR(6) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS user_id INTEGER DEFAULT NULL,
ADD CONSTRAINT fk_child_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_children_user_id ON children(user_id);
```

### 1.3 åˆ›å»ºuser_childrenè¡¨ï¼ˆç”¨æˆ·-å°æœ‹å‹å…³è”è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS user_children (
    user_id INTEGER NOT NULL,
    child_id INTEGER NOT NULL,
    relationship VARCHAR(50) DEFAULT 'parent',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, child_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_child_id (child_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 2. åˆ›å»ºé¡¹ç›®ç›¸å…³è¡¨

### 2.1 åˆ›å»ºprojectsè¡¨ï¼ˆé¡¹ç›®è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS projects (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type ENUM('add', 'subtract') NOT NULL,
    value INTEGER NOT NULL,
    category VARCHAR(50),
    description TEXT,
    icon VARCHAR(50),
    repeat_rule VARCHAR(20) DEFAULT 'unlimited',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_by INTEGER NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_type (type),
    INDEX idx_category (category),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2.2 åˆ›å»ºproject_childrenè¡¨ï¼ˆé¡¹ç›®-å°æœ‹å‹å…³è”è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS project_children (
    project_id INTEGER NOT NULL,
    child_id INTEGER NOT NULL,
    custom_value INTEGER,
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (project_id, child_id),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_child_id (child_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2.3 æ›´æ–°star_recordsè¡¨ï¼ˆæ·»åŠ é¡¹ç›®å…³è”ï¼‰
```sql
-- ä¸ºstar_recordsè¡¨æ·»åŠ é¡¹ç›®å…³è”å­—æ®µ
ALTER TABLE star_records 
ADD COLUMN IF NOT EXISTS project_id INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS operator_id INTEGER DEFAULT NULL,
ADD CONSTRAINT fk_star_project FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_star_operator FOREIGN KEY (operator_id) REFERENCES users(id) ON DELETE SET NULL;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_star_records_project_id ON star_records(project_id);
CREATE INDEX IF NOT EXISTS idx_star_records_operator_id ON star_records(operator_id);
```

## 3. åˆ›å»ºç»Ÿè®¡åˆ†æç›¸å…³è¡¨

### 3.1 åˆ›å»ºdaily_summariesè¡¨ï¼ˆæ¯æ—¥æ€»ç»“è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS daily_summaries (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    summary_date DATE NOT NULL UNIQUE,
    total_stars_earned INTEGER NOT NULL DEFAULT 0,
    total_stars_spent INTEGER NOT NULL DEFAULT 0,
    active_children INTEGER NOT NULL DEFAULT 0,
    summary_data JSON,
    insights TEXT,
    recommendations TEXT,
    generated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_summary_date (summary_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 3.2 åˆ›å»ºchild_daily_statsè¡¨ï¼ˆå°æœ‹å‹æ¯æ—¥ç»Ÿè®¡è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS child_daily_stats (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    child_id INTEGER NOT NULL,
    stat_date DATE NOT NULL,
    stars_earned INTEGER NOT NULL DEFAULT 0,
    stars_spent INTEGER NOT NULL DEFAULT 0,
    tasks_completed INTEGER NOT NULL DEFAULT 0,
    behavior_score INTEGER,
    mood VARCHAR(20),
    notes TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_child_date (child_id, stat_date),
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_stat_date (stat_date),
    INDEX idx_child_date (child_id, stat_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 4. åˆ›å»ºç³»ç»Ÿç®¡ç†ç›¸å…³è¡¨

### 4.1 åˆ›å»ºsessionsè¡¨ï¼ˆä¼šè¯è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS sessions (
    id VARCHAR(100) PRIMARY KEY,
    user_id INTEGER NOT NULL,
    ip_address VARCHAR(50),
    user_agent VARCHAR(255),
    device_type VARCHAR(50),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 4.2 åˆ›å»ºaudit_logsè¡¨ï¼ˆå®¡è®¡æ—¥å¿—è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER,
    action VARCHAR(100) NOT NULL,
    target_type VARCHAR(50),
    target_id INTEGER,
    old_value JSON,
    new_value JSON,
    ip_address VARCHAR(50),
    user_agent VARCHAR(255),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_target (target_type, target_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 4.3 åˆ›å»ºnotificationsè¡¨ï¼ˆé€šçŸ¥è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS notifications (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    is_read BOOLEAN NOT NULL DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_is_read (is_read),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 4.4 åˆ›å»ºsystem_settingsè¡¨ï¼ˆç³»ç»Ÿè®¾ç½®è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS system_settings (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    setting_key VARCHAR(100) NOT NULL UNIQUE,
    setting_value TEXT,
    setting_type VARCHAR(50) DEFAULT 'string',
    description TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_setting_key (setting_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 5. æ’å…¥åˆå§‹æ•°æ®

### 5.1 åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·

```sql
-- æ³¨æ„ï¼šå¯†ç éœ€è¦ä½¿ç”¨å®é™…çš„å¯†ç å“ˆå¸Œå‡½æ•°ç”Ÿæˆ
-- è¿™é‡Œçš„å¯†ç å“ˆå¸Œæ˜¯ 'admin123' çš„bcryptå“ˆå¸Œå€¼ï¼ˆç¤ºä¾‹ï¼‰
-- å®é™…ä½¿ç”¨æ—¶è¯·æ›´æ”¹å¯†ç å¹¶ä½¿ç”¨é€‚å½“çš„å“ˆå¸Œæ–¹æ³•

INSERT INTO users (username, email, password_hash, role, is_active, is_verified) VALUES
('admin', 'admin@starsavings.com', '$2b$10$YourHashedPasswordHere', 'admin', TRUE, TRUE);

-- åˆ›å»ºé»˜è®¤å®¶é•¿è´¦æˆ·ï¼ˆå¯†ç ï¼šparent123ï¼‰
INSERT INTO users (username, email, password_hash, role, is_active, is_verified) VALUES
('parent1', 'parent@example.com', '$2b$10$YourHashedPasswordHere', 'parent', TRUE, TRUE);
```

### 5.2 æ’å…¥é»˜è®¤ç³»ç»Ÿè®¾ç½®

```sql
INSERT INTO system_settings (setting_key, setting_value, setting_type, description) VALUES
('site_name', 'æ˜Ÿæ˜Ÿå­˜æŠ˜', 'string', 'ç½‘ç«™åç§°'),
('theme', 'default', 'string', 'ç½‘ç«™ä¸»é¢˜'),
('language', 'zh-CN', 'string', 'é»˜è®¤è¯­è¨€'),
('daily_star_limit', '100', 'integer', 'æ¯æ—¥æ˜Ÿæ˜Ÿä¸Šé™'),
('min_stars_balance', '0', 'integer', 'æœ€ä½æ˜Ÿæ˜Ÿä½™é¢'),
('allow_negative_stars', 'false', 'boolean', 'æ˜¯å¦å…è®¸è´Ÿæ˜Ÿæ˜Ÿ'),
('email_notifications', 'true', 'boolean', 'æ˜¯å¦å¯ç”¨é‚®ä»¶é€šçŸ¥'),
('daily_summary_time', '20:00', 'string', 'æ¯æ—¥æ€»ç»“ç”Ÿæˆæ—¶é—´'),
('weekly_report_day', 'sunday', 'string', 'å‘¨æŠ¥ç”Ÿæˆæ—¥æœŸ'),
('max_login_attempts', '5', 'integer', 'æœ€å¤§ç™»å½•å°è¯•æ¬¡æ•°'),
('session_timeout', '1440', 'integer', 'ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'),
('password_min_length', '8', 'integer', 'å¯†ç æœ€å°é•¿åº¦'),
('enable_child_login', 'true', 'boolean', 'æ˜¯å¦å¯ç”¨å„¿ç«¥ç™»å½•'),
('child_session_timeout', '30', 'integer', 'å„¿ç«¥ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰');
```

### 5.3 åˆ›å»ºé»˜è®¤é¡¹ç›®æ¨¡æ¿

```sql
-- æ’å…¥é»˜è®¤çš„åŠ åˆ†é¡¹ç›®
INSERT INTO projects (name, type, value, category, description, icon, repeat_rule, is_active, created_by) VALUES
('å®Œæˆä½œä¸š', 'add', 5, 'å­¦ä¹ ', 'æŒ‰æ—¶å®Œæˆå½“å¤©çš„ä½œä¸š', 'ğŸ“š', 'daily', TRUE, 1),
('é˜…è¯»30åˆ†é’Ÿ', 'add', 3, 'å­¦ä¹ ', 'åšæŒé˜…è¯»30åˆ†é’Ÿ', 'ğŸ“–', 'daily', TRUE, 1),
('å¸®åŠ©åšå®¶åŠ¡', 'add', 3, 'ç”Ÿæ´»', 'ä¸»åŠ¨å¸®åŠ©åšå®¶åŠ¡', 'ğŸ ', 'unlimited', TRUE, 1),
('è¿åŠ¨30åˆ†é’Ÿ', 'add', 3, 'è¿åŠ¨', 'è¿›è¡Œ30åˆ†é’Ÿä½“è‚²è¿åŠ¨', 'âš½', 'daily', TRUE, 1),
('æ—©ç¡æ—©èµ·', 'add', 2, 'ç”Ÿæ´»', 'æŒ‰æ—¶ç¡è§‰å’Œèµ·åºŠ', 'ğŸ›ï¸', 'daily', TRUE, 1),
('ç¤¼è²Œç”¨è¯­', 'add', 1, 'ç¤¾äº¤', 'ä½¿ç”¨ç¤¼è²Œç”¨è¯­', 'ğŸ¤', 'unlimited', TRUE, 1);

-- æ’å…¥é»˜è®¤çš„æ‰£åˆ†é¡¹ç›®
INSERT INTO projects (name, type, value, category, description, icon, repeat_rule, is_active, created_by) VALUES
('ä¸å®Œæˆä½œä¸š', 'subtract', 5, 'å­¦ä¹ ', 'æœªå®Œæˆä½œä¸š', 'âŒ', 'daily', TRUE, 1),
('æŒ‘é£Ÿ', 'subtract', 2, 'ç”Ÿæ´»', 'åƒé¥­æŒ‘é£Ÿ', 'ğŸ½ï¸', 'unlimited', TRUE, 1),
('ä¸æŒ‰æ—¶ç¡è§‰', 'subtract', 3, 'ç”Ÿæ´»', 'è¶…è¿‡è§„å®šæ—¶é—´ä¸ç¡è§‰', 'ğŸŒ™', 'daily', TRUE, 1),
('è¯´è°', 'subtract', 5, 'å“å¾·', 'è¯´è°è¯', 'ğŸš«', 'unlimited', TRUE, 1),
('æ‰“æ¶', 'subtract', 10, 'è¡Œä¸º', 'ä¸ä»–äººæ‰“æ¶', 'ğŸ‘Š', 'unlimited', TRUE, 1);
```

### 5.4 åˆ›å»ºæµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰

```sql
-- åˆ›å»ºæµ‹è¯•å°æœ‹å‹ï¼ˆå…³è”åˆ°é»˜è®¤å®¶é•¿è´¦æˆ·ï¼‰
INSERT INTO children (name, birthday, gender, star_count, pin_code) VALUES
('å°æ˜', '2018-05-20', 'boy', 50, '1234'),
('å°çº¢', '2019-03-15', 'girl', 35, '5678');

-- å…³è”å°æœ‹å‹åˆ°å®¶é•¿
INSERT INTO user_children (user_id, child_id, relationship) VALUES
(2, 1, 'parent'),  -- parent1ç”¨æˆ·å…³è”å°æ˜
(2, 2, 'parent');  -- parent1ç”¨æˆ·å…³è”å°çº¢

-- å…³è”é¡¹ç›®åˆ°å°æœ‹å‹
INSERT INTO project_children (project_id, child_id) VALUES
(1, 1), (1, 2),  -- å®Œæˆä½œä¸šé¡¹ç›®å…³è”åˆ°å°æ˜å’Œå°çº¢
(2, 1), (2, 2),  -- é˜…è¯»30åˆ†é’Ÿé¡¹ç›®å…³è”åˆ°å°æ˜å’Œå°çº¢
(3, 1), (3, 2);  -- å¸®åŠ©åšå®¶åŠ¡é¡¹ç›®å…³è”åˆ°å°æ˜å’Œå°çº¢
```

## 6. Pythonåˆå§‹åŒ–è„šæœ¬

åˆ›å»ºä¸€ä¸ªPythonè„šæœ¬æ¥åˆå§‹åŒ–æ•°æ®åº“å’Œåˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼š

```python
# init_database.py
import os
from datetime import datetime
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
import bcrypt
from app.models import Base, User, SystemSetting
from app.core.config import settings

def hash_password(password: str) -> str:
    """ç”Ÿæˆå¯†ç å“ˆå¸Œ"""
    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
    return hashed.decode('utf-8')

def init_database():
    """åˆå§‹åŒ–æ•°æ®åº“"""
    # åˆ›å»ºæ•°æ®åº“å¼•æ“
    engine = create_engine(settings.DATABASE_URL)
    
    # åˆ›å»ºæ‰€æœ‰è¡¨
    Base.metadata.create_all(bind=engine)
    print("âœ… æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ")
    
    # åˆ›å»ºä¼šè¯
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    db = SessionLocal()
    
    try:
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç®¡ç†å‘˜
        admin = db.query(User).filter(User.role == "admin").first()
        if not admin:
            # åˆ›å»ºè¶…çº§ç®¡ç†å‘˜
            admin_password = os.getenv('ADMIN_PASSWORD', 'admin123')
            admin_user = User(
                username='admin',
                email='admin@starsavings.com',
                password_hash=hash_password(admin_password),
                role='admin',
                is_active=True,
                is_verified=True
            )
            db.add(admin_user)
            db.commit()
            print(f"âœ… ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ")
            print(f"   ç”¨æˆ·å: admin")
            print(f"   å¯†ç : {admin_password}")
            print(f"   âš ï¸  è¯·ç«‹å³ç™»å½•å¹¶ä¿®æ”¹å¯†ç ï¼")
        else:
            print("â„¹ï¸  ç®¡ç†å‘˜è´¦æˆ·å·²å­˜åœ¨")
        
        # åˆ›å»ºé»˜è®¤å®¶é•¿è´¦æˆ·ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        demo_parent = db.query(User).filter(User.username == "demo_parent").first()
        if not demo_parent:
            demo_parent = User(
                username='demo_parent',
                email='demo@example.com',
                password_hash=hash_password('demo123'),
                role='parent',
                is_active=True,
                is_verified=True
            )
            db.add(demo_parent)
            db.commit()
            print(f"âœ… æ¼”ç¤ºå®¶é•¿è´¦æˆ·åˆ›å»ºæˆåŠŸ")
            print(f"   ç”¨æˆ·å: demo_parent")
            print(f"   å¯†ç : demo123")
        
        # åˆå§‹åŒ–ç³»ç»Ÿè®¾ç½®
        init_system_settings(db)
        
        db.commit()
        print("âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")
        
    except Exception as e:
        print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")
        db.rollback()
    finally:
        db.close()

def init_system_settings(db):
    """åˆå§‹åŒ–ç³»ç»Ÿè®¾ç½®"""
    default_settings = [
        ('site_name', 'æ˜Ÿæ˜Ÿå­˜æŠ˜', 'string', 'ç½‘ç«™åç§°'),
        ('daily_star_limit', '100', 'integer', 'æ¯æ—¥æ˜Ÿæ˜Ÿä¸Šé™'),
        ('allow_negative_stars', 'false', 'boolean', 'æ˜¯å¦å…è®¸è´Ÿæ˜Ÿæ˜Ÿ'),
        ('session_timeout', '1440', 'integer', 'ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'),
        ('enable_child_login', 'true', 'boolean', 'æ˜¯å¦å¯ç”¨å„¿ç«¥ç™»å½•'),
    ]
    
    for key, value, type_, desc in default_settings:
        setting = db.query(SystemSetting).filter(
            SystemSetting.setting_key == key
        ).first()
        if not setting:
            setting = SystemSetting(
                setting_key=key,
                setting_value=value,
                setting_type=type_,
                description=desc
            )
            db.add(setting)
    
    print("âœ… ç³»ç»Ÿè®¾ç½®åˆå§‹åŒ–æˆåŠŸ")

if __name__ == "__main__":
    init_database()
```

## 7. ç¯å¢ƒé…ç½®æ–‡ä»¶

åˆ›å»º `.env` æ–‡ä»¶æ¥é…ç½®ç®¡ç†å‘˜å¯†ç ï¼š

```env
# .env
DATABASE_URL=mysql+pymysql://root:password@localhost/star_db
# æˆ–è€…SQLite
# DATABASE_URL=sqlite:///./star_db.db

# ç®¡ç†å‘˜åˆå§‹å¯†ç ï¼ˆé¦–æ¬¡è¿è¡Œæ—¶ä½¿ç”¨ï¼‰
ADMIN_PASSWORD=StrongAdminPassword123!

# JWTå¯†é’¥
SECRET_KEY=your-secret-key-here-change-this-in-production

# å…¶ä»–é…ç½®
DEBUG=false
PORT=8000
```

## 8. è¿è¡Œåˆå§‹åŒ–

### æ–¹å¼ä¸€ï¼šä½¿ç”¨SQLè„šæœ¬
```bash
# MySQL
mysql -u root -p star_db < init_database.sql

# æˆ–è€…åœ¨MySQLå‘½ä»¤è¡Œä¸­
mysql> source /path/to/init_database.sql;
```

### æ–¹å¼äºŒï¼šä½¿ç”¨Pythonè„šæœ¬
```bash
# å®‰è£…ä¾èµ–
pip install bcrypt sqlalchemy pymysql

# è¿è¡Œåˆå§‹åŒ–è„šæœ¬
python init_database.py
```

## 9. éªŒè¯åˆå§‹åŒ–

### æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
SHOW TABLES;

-- éªŒè¯ç”¨æˆ·è¡¨
SELECT id, username, email, role, is_active FROM users;

-- éªŒè¯ç³»ç»Ÿè®¾ç½®
SELECT setting_key, setting_value FROM system_settings;

-- éªŒè¯é¡¹ç›®è¡¨
SELECT id, name, type, value, category FROM projects;
```

### æµ‹è¯•ç™»å½•
```python
# test_login.py
import bcrypt

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return bcrypt.checkpw(
        plain_password.encode('utf-8'),
        hashed_password.encode('utf-8')
    )

# æµ‹è¯•ç®¡ç†å‘˜ç™»å½•
# ä½¿ç”¨å®é™…çš„å¯†ç å“ˆå¸Œå€¼è¿›è¡Œæµ‹è¯•
```

## 10. å®‰å…¨æ³¨æ„äº‹é¡¹

### é‡è¦æé†’

1. **ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç **
   - é¦–æ¬¡ç™»å½•åå¿…é¡»ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
   - åˆ é™¤æˆ–ä¿®æ”¹æ‰€æœ‰é»˜è®¤è´¦æˆ·å¯†ç 

2. **å¯†ç å®‰å…¨è¦æ±‚**
   - æœ€å°é•¿åº¦ï¼š8ä¸ªå­—ç¬¦
   - å¿…é¡»åŒ…å«ï¼šå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
   - å®šæœŸæ›´æ¢å¯†ç 

3. **æ•°æ®åº“æƒé™**
   - ä¸ºåº”ç”¨åˆ›å»ºä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
   - åªæˆäºˆå¿…è¦çš„æƒé™
   - ä¸ä½¿ç”¨rootè´¦æˆ·è¿è¡Œåº”ç”¨

4. **å¤‡ä»½ç­–ç•¥**
   - å®šæœŸå¤‡ä»½æ•°æ®åº“
   - æµ‹è¯•æ¢å¤æµç¨‹
   - åŠ å¯†å¤‡ä»½æ–‡ä»¶

### ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

```sql
-- åˆ›å»ºåº”ç”¨ä¸“ç”¨ç”¨æˆ·
CREATE USER 'star_app'@'localhost' IDENTIFIED BY 'VeryStrongPassword123!';
GRANT SELECT, INSERT, UPDATE, DELETE ON star_db.* TO 'star_app'@'localhost';
FLUSH PRIVILEGES;

-- é™åˆ¶ç®¡ç†å‘˜è´¦æˆ·è®¿é—®
UPDATE users SET 
  login_attempts = 0,
  locked_until = NULL
WHERE username = 'admin';

-- å¯ç”¨å®¡è®¡æ—¥å¿—
INSERT INTO audit_logs (user_id, action, target_type, created_at)
VALUES (1, 'system_init', 'database', NOW());
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¡¨å·²å­˜åœ¨é”™è¯¯**
   ```sql
   DROP TABLE IF EXISTS table_name;
   -- æˆ–ä½¿ç”¨ CREATE TABLE IF NOT EXISTS
   ```

2. **å¤–é”®çº¦æŸé”™è¯¯**
   - ç¡®ä¿æŒ‰æ­£ç¡®é¡ºåºåˆ›å»ºè¡¨
   - æ£€æŸ¥å¼•ç”¨çš„è¡¨å’Œå­—æ®µæ˜¯å¦å­˜åœ¨

3. **å­—ç¬¦é›†é—®é¢˜**
   ```sql
   ALTER DATABASE star_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

4. **å¯†ç å“ˆå¸Œé—®é¢˜**
   - ç¡®ä¿å®‰è£…äº†bcryptåº“
   - ä½¿ç”¨æ­£ç¡®çš„å“ˆå¸Œç®—æ³•
