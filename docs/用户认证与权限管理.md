# 用户认证与权限管理设计文档

## 概述

本文档详细说明星星存折系统的用户认证和权限管理方案，包括儿童端和家长端的不同登录方式、权限控制、安全机制等。

## 用户角色设计

### 1. 角色分类

#### 儿童角色 (Child)
- **权限级别**: 只读
- **访问范围**: 仅限个人数据
- **功能权限**:
  - 查看自己的星星数量
  - 查看可兑换的奖品
  - 查看个人历史记录
  - 查看成就和排行榜

#### 家长角色 (Parent)
- **权限级别**: 管理员
- **访问范围**: 所有关联的小朋友数据
- **功能权限**:
  - 所有儿童权限
  - 添加/编辑/删除小朋友
  - 管理星星（加/减）
  - 管理奖品
  - 管理项目配置
  - 查看数据报表

#### 超级管理员 (SuperAdmin)
- **权限级别**: 系统级
- **访问范围**: 系统所有数据
- **功能权限**:
  - 所有家长权限
  - 系统配置管理
  - 用户管理
  - 数据备份恢复
  - 系统日志查看

### 2. 权限矩阵

| 功能模块 | 儿童 | 家长 | 超管 |
|---------|------|------|------|
| 查看个人星星 | ✓ | ✓ | ✓ |
| 查看他人星星 | × | ✓ | ✓ |
| 添加/减少星星 | × | ✓ | ✓ |
| 管理小朋友 | × | ✓ | ✓ |
| 管理奖品 | × | ✓ | ✓ |
| 管理项目 | × | ✓ | ✓ |
| 数据分析 | × | ✓ | ✓ |
| 系统配置 | × | × | ✓ |
| 用户管理 | × | × | ✓ |

## 认证系统设计

### 1. 儿童端认证

#### 登录方式
1. **图形密码登录**
   - 选择喜欢的动物/图案组合
   - 适合不会打字的小朋友
   - 支持触摸屏操作

2. **简单PIN码**
   - 4-6位数字密码
   - 大按钮数字键盘
   - 支持指纹/面部识别（如设备支持）

3. **头像选择登录**
   - 直接点击自己的头像
   - 输入简单密码确认
   - 适合多人共用设备

#### 安全措施
- 限制登录尝试次数（3次失败锁定5分钟）
- 家长可重置儿童密码
- 登录后自动超时（30分钟无操作）

### 2. 家长端认证

#### 登录方式
1. **账号密码登录**
   - 邮箱/手机号 + 密码
   - 密码强度要求（至少8位，包含字母和数字）
   - 支持记住登录状态

2. **二次验证（可选）**
   - 短信验证码
   - 邮箱验证码
   - Google Authenticator

3. **社交账号登录**
   - 微信登录
   - QQ登录
   - Apple ID（iOS）

#### 密码管理
- 忘记密码（邮箱/短信重置）
- 定期更换密码提醒
- 密码历史记录（不能使用最近5个密码）

## 技术实现方案

### 1. JWT Token认证

#### Token结构
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": "123456",
    "role": "parent",
    "username": "parent@example.com",
    "children_ids": [1, 2, 3],
    "permissions": ["read", "write", "admin"],
    "exp": 1640995200,
    "iat": 1640908800
  }
}
```

#### Token管理
- **Access Token**: 有效期15分钟
- **Refresh Token**: 有效期7天
- **Token刷新机制**: 自动续期
- **Token黑名单**: 登出后立即失效

### 2. 后端实现

#### 用户模型
```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    username = Column(String(100), unique=True, nullable=False)
    email = Column(String(100), unique=True)
    phone = Column(String(20), unique=True)
    password_hash = Column(String(255), nullable=False)
    role = Column(Enum(UserRole), default=UserRole.PARENT)
    is_active = Column(Boolean, default=True)
    is_verified = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    last_login = Column(DateTime)
    
    # 关系
    children = relationship("Child", back_populates="parent")
    sessions = relationship("UserSession", back_populates="user")
```

#### 认证接口
```python
# 登录接口
@router.post("/auth/login")
async def login(credentials: LoginCredentials, db: Session = Depends(get_db)):
    # 验证用户凭证
    user = authenticate_user(db, credentials)
    if not user:
        raise HTTPException(status_code=401, detail="Invalid credentials")
    
    # 生成Token
    access_token = create_access_token(user)
    refresh_token = create_refresh_token(user)
    
    # 记录登录日志
    log_user_login(db, user.id)
    
    return {
        "access_token": access_token,
        "refresh_token": refresh_token,
        "token_type": "bearer",
        "user": UserResponse.from_orm(user)
    }

# 儿童登录接口
@router.post("/auth/child-login")
async def child_login(
    child_id: int,
    pin: str,
    db: Session = Depends(get_db)
):
    # 验证儿童PIN码
    child = verify_child_pin(db, child_id, pin)
    if not child:
        raise HTTPException(status_code=401, detail="Invalid PIN")
    
    # 生成儿童专用Token
    token = create_child_token(child)
    
    return {
        "access_token": token,
        "child": ChildResponse.from_orm(child)
    }
```

### 3. 权限控制装饰器

```python
from functools import wraps
from fastapi import Depends, HTTPException, status

def require_role(allowed_roles: List[UserRole]):
    """权限验证装饰器"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="Not authenticated"
                )
            
            if current_user.role not in allowed_roles:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail="Insufficient permissions"
                )
            
            return await func(*args, **kwargs)
        return wrapper
    return decorator

# 使用示例
@router.post("/stars/add")
@require_role([UserRole.PARENT, UserRole.SUPER_ADMIN])
async def add_stars(
    child_id: int,
    amount: int,
    current_user: User = Depends(get_current_user)
):
    # 只有家长和超管可以添加星星
    pass
```

### 4. 前端实现

#### 路由守卫
```typescript
// router/guards.ts
export const authGuard = (to: Route, from: Route, next: Function) => {
  const token = localStorage.getItem('access_token')
  const userRole = store.getters['auth/userRole']
  
  if (to.meta.requiresAuth && !token) {
    next('/login')
    return
  }
  
  if (to.meta.roles && !to.meta.roles.includes(userRole)) {
    next('/403')
    return
  }
  
  next()
}

// 路由配置
const routes = [
  {
    path: '/admin',
    component: AdminLayout,
    meta: { requiresAuth: true, roles: ['parent', 'admin'] },
    children: [
      {
        path: 'children',
        component: ChildrenManagement,
        meta: { requiresAuth: true, roles: ['parent'] }
      }
    ]
  },
  {
    path: '/child-view',
    component: ChildView,
    meta: { requiresAuth: true, roles: ['child'] }
  }
]
```

#### 儿童登录界面
```vue
<template>
  <div class="child-login">
    <h1 class="text-4xl mb-8">选择你的头像</h1>
    
    <!-- 头像网格 -->
    <div class="avatar-grid">
      <div 
        v-for="child in children" 
        :key="child.id"
        @click="selectChild(child)"
        class="avatar-item"
      >
        <img :src="child.avatar" :alt="child.name">
        <p>{{ child.name }}</p>
      </div>
    </div>
    
    <!-- PIN码输入 -->
    <div v-if="selectedChild" class="pin-input">
      <h2>输入你的密码</h2>
      <div class="pin-dots">
        <span 
          v-for="i in 4" 
          :key="i"
          :class="{ filled: pin.length >= i }"
        ></span>
      </div>
      <div class="number-pad">
        <button 
          v-for="num in [1,2,3,4,5,6,7,8,9,0]"
          :key="num"
          @click="inputPin(num)"
          class="num-btn"
        >
          {{ num }}
        </button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.avatar-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 2rem;
}

.avatar-item {
  cursor: pointer;
  text-align: center;
  transition: transform 0.3s;
}

.avatar-item:hover {
  transform: scale(1.1);
}

.avatar-item img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid transparent;
}

.avatar-item.selected img {
  border-color: #4CAF50;
}

.number-pad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  max-width: 300px;
  margin: 0 auto;
}

.num-btn {
  width: 80px;
  height: 80px;
  font-size: 2rem;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  cursor: pointer;
}
</style>
```

## 安全机制

### 1. 密码安全
- **加密存储**: 使用bcrypt加密密码
- **密码强度检查**: 前后端双重验证
- **密码历史**: 防止重复使用旧密码
- **强制修改**: 首次登录强制修改初始密码

### 2. 会话管理
```python
class UserSession(Base):
    __tablename__ = "user_sessions"
    
    id = Column(String(100), primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    ip_address = Column(String(50))
    user_agent = Column(String(255))
    created_at = Column(DateTime, default=datetime.utcnow)
    expires_at = Column(DateTime)
    is_active = Column(Boolean, default=True)
    
    user = relationship("User", back_populates="sessions")
```

### 3. 登录限制
- **IP限制**: 同一IP连续失败5次锁定1小时
- **账号锁定**: 连续失败10次锁定账号
- **地理位置检测**: 异地登录提醒
- **设备绑定**: 新设备登录需要验证

### 4. 审计日志
```python
class AuditLog(Base):
    __tablename__ = "audit_logs"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    action = Column(String(100))  # login, logout, add_stars, etc.
    target_type = Column(String(50))  # child, reward, etc.
    target_id = Column(Integer)
    details = Column(JSON)
    ip_address = Column(String(50))
    timestamp = Column(DateTime, default=datetime.utcnow)
```

## API接口设计

### 认证相关接口

| 接口 | 方法 | 说明 | 权限 |
|------|------|------|------|
| /api/auth/register | POST | 家长注册 | 公开 |
| /api/auth/login | POST | 家长登录 | 公开 |
| /api/auth/child-login | POST | 儿童登录 | 公开 |
| /api/auth/logout | POST | 登出 | 需认证 |
| /api/auth/refresh | POST | 刷新Token | 需RefreshToken |
| /api/auth/verify-email | GET | 邮箱验证 | 公开 |
| /api/auth/reset-password | POST | 重置密码 | 公开 |
| /api/auth/change-password | PUT | 修改密码 | 需认证 |
| /api/auth/sessions | GET | 查看活动会话 | 需认证 |
| /api/auth/sessions/{id} | DELETE | 结束会话 | 需认证 |

### 用户管理接口

| 接口 | 方法 | 说明 | 权限 |
|------|------|------|------|
| /api/users/profile | GET | 获取个人信息 | 需认证 |
| /api/users/profile | PUT | 更新个人信息 | 需认证 |
| /api/users/children | GET | 获取关联的小朋友 | Parent |
| /api/users/children/{id}/pin | PUT | 设置儿童PIN码 | Parent |
| /api/users/preferences | GET | 获取用户偏好设置 | 需认证 |
| /api/users/preferences | PUT | 更新偏好设置 | 需认证 |

## 数据隐私保护

### 1. 数据访问控制
- 儿童只能访问自己的数据
- 家长只能访问自己孩子的数据
- 数据导出需要二次验证
- 敏感操作需要重新输入密码

### 2. 数据加密
- 传输加密：HTTPS/TLS
- 存储加密：敏感字段AES加密
- 密码加密：bcrypt + salt
- Token签名：HMAC-SHA256

### 3. 隐私设置
- 可选择是否在排行榜显示真名
- 可设置数据分享范围
- 支持账户注销和数据删除
- 符合GDPR和儿童隐私保护法规

## 实施计划

### 第一阶段：基础认证
- [ ] 实现家长注册/登录
- [ ] 实现JWT认证机制
- [ ] 基本的权限控制

### 第二阶段：儿童认证
- [ ] 实现儿童登录界面
- [ ] PIN码管理功能
- [ ] 儿童专用界面

### 第三阶段：高级功能
- [ ] 二次验证
- [ ] 社交登录
- [ ] 生物识别登录

### 第四阶段：安全加固
- [ ] 审计日志系统
- [ ] 异常检测
- [ ] 数据加密增强
