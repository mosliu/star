# 部署指南

## 环境要求

### 系统要求
- 操作系统: Linux (Ubuntu 20.04+) / Windows Server 2019+ / macOS 11+
- CPU: 2核心以上
- 内存: 4GB以上
- 硬盘: 20GB可用空间
- 网络: 具有公网IP或域名

### 软件依赖
- Docker 20.10+
- Docker Compose 2.0+
- Node.js 18+ (开发环境)
- Python 3.11+ (开发环境)
- MySQL 8.0+ 或 SQLite 3.35+
- Nginx 1.20+ (可选)

## 快速部署（Docker方式）

### 1. 克隆项目
```bash
git clone https://github.com/your-org/star-savings.git
cd star-savings
```

### 2. 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
vim .env
```

环境变量说明：
```env
# 数据库配置
DATABASE_URL=mysql+pymysql://root:password@db:3306/star_db
# 或使用SQLite
# DATABASE_URL=sqlite:///./star_db.db

# 应用配置
SECRET_KEY=your-secret-key-here
DEBUG=false
PORT=8000

# 前端配置
VITE_API_URL=http://api.yourdomain.com/api

# 上传配置
MAX_UPLOAD_SIZE=10485760  # 10MB
UPLOAD_PATH=/app/uploads
```

### 3. 构建和启动
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 4. 初始化数据库
```bash
# 进入后端容器
docker-compose exec backend bash

# 运行数据库初始化
python init_db.py

# 或运行迁移
alembic upgrade head
```

## 手动部署

### 后端部署

#### 1. 安装Python环境
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.11 python3.11-venv python3-pip

# CentOS/RHEL
sudo yum install python3.11

# macOS
brew install python@3.11
```

#### 2. 创建虚拟环境
```bash
cd python_backend
python3.11 -m venv venv
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate  # Windows
```

#### 3. 安装依赖
```bash
pip install -r requirements.txt
```

#### 4. 配置数据库
```bash
# 编辑.env文件
cp .env.example .env
vim .env

# 初始化数据库
python init_db.py

# 运行迁移
alembic upgrade head
```

#### 5. 启动服务
```bash
# 开发环境
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# 生产环境
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 前端部署

#### 1. 安装Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# macOS
brew install node@18

# 使用nvm（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18
```

#### 2. 安装依赖
```bash
cd frontend
npm install
# 或使用pnpm
pnpm install
```

#### 3. 配置环境
```bash
# 编辑.env文件
cp .env.example .env
vim .env

# 设置API地址
VITE_API_URL=http://your-backend-url:8000/api
```

#### 4. 构建项目
```bash
# 构建生产版本
npm run build

# 构建产物在dist目录
ls -la dist/
```

#### 5. 部署静态文件
```bash
# 使用Nginx
sudo cp -r dist/* /var/www/html/star-savings/

# 或使用Python简单服务器
python -m http.server 8080 --directory dist
```

## Nginx配置

### 1. 安装Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx

# macOS
brew install nginx
```

### 2. 配置反向代理
创建配置文件 `/etc/nginx/sites-available/star-savings`:

```nginx
server {
    listen 80;
    server_name star-savings.com www.star-savings.com;

    # 前端静态文件
    location / {
        root /var/www/html/star-savings;
        try_files $uri $uri/ /index.html;
        
        # 开启gzip压缩
        gzip on;
        gzip_types text/css application/javascript image/svg+xml;
        
        # 缓存策略
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # API反向代理
    location /api {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 上传文件大小限制
        client_max_body_size 10M;
    }

    # 上传文件访问
    location /uploads {
        alias /app/uploads;
        expires 7d;
        add_header Cache-Control "public";
    }
}
```

### 3. 启用配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/star-savings /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

## SSL配置（HTTPS）

### 使用Let's Encrypt
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d star-savings.com -d www.star-savings.com

# 自动续期
sudo certbot renew --dry-run
```

### Nginx SSL配置
```nginx
server {
    listen 443 ssl http2;
    server_name star-savings.com;

    ssl_certificate /etc/letsencrypt/live/star-savings.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/star-savings.com/privkey.pem;
    
    # SSL优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # 其他配置同上...
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name star-savings.com www.star-savings.com;
    return 301 https://$server_name$request_uri;
}
```

## 进程管理

### 使用systemd（Linux）

创建服务文件 `/etc/systemd/system/star-backend.service`:

```ini
[Unit]
Description=Star Savings Backend
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/star-savings/python_backend
Environment="PATH=/opt/star-savings/python_backend/venv/bin"
ExecStart=/opt/star-savings/python_backend/venv/bin/gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

管理服务：
```bash
# 重载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start star-backend

# 开机自启
sudo systemctl enable star-backend

# 查看状态
sudo systemctl status star-backend

# 查看日志
sudo journalctl -u star-backend -f
```

### 使用PM2（Node.js）

```bash
# 安装PM2
npm install -g pm2

# 启动后端
pm2 start "uvicorn main:app --host 0.0.0.0 --port 8000" --name star-backend

# 启动前端开发服务器（如需要）
pm2 start "npm run dev" --name star-frontend

# 保存配置
pm2 save

# 开机自启
pm2 startup
```

## 数据库备份

### 自动备份脚本

创建备份脚本 `/opt/scripts/backup-star.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/opt/backups/star-savings"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="star_db"
DB_USER="root"
DB_PASS="password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# MySQL备份
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/star_db_$DATE.sql

# 压缩备份
gzip $BACKUP_DIR/star_db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# 上传到对象存储（可选）
# aws s3 cp $BACKUP_DIR/star_db_$DATE.sql.gz s3://your-bucket/backups/
```

### 定时任务

```bash
# 编辑crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /opt/scripts/backup-star.sh >> /var/log/star-backup.log 2>&1
```

## 监控配置

### 健康检查接口

后端提供健康检查接口：
```python
@app.get("/health")
def health_check():
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow(),
        "version": "1.0.0"
    }
```

### 使用Prometheus + Grafana

1. 安装Prometheus导出器：
```bash
pip install prometheus-fastapi-instrumentator
```

2. 配置指标收集：
```python
from prometheus_fastapi_instrumentator import Instrumentator

instrumentator = Instrumentator()
instrumentator.instrument(app).expose(app)
```

3. 配置Grafana仪表板监控关键指标

## 性能优化

### 1. 数据库优化
- 添加适当的索引
- 使用连接池
- 定期清理历史数据

### 2. 缓存配置
```python
# 使用Redis缓存
import redis
cache = redis.Redis(host='localhost', port=6379, db=0)
```

### 3. CDN配置
- 静态资源使用CDN
- 图片压缩和WebP格式
- 启用HTTP/2

### 4. 负载均衡
使用Nginx upstream配置：
```nginx
upstream backend {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
}

location /api {
    proxy_pass http://backend;
}
```

## 故障排查

### 常见问题

#### 1. 端口被占用
```bash
# 查找占用端口的进程
lsof -i :8000
# 或
netstat -tulpn | grep 8000

# 终止进程
kill -9 <PID>
```

#### 2. 数据库连接失败
- 检查数据库服务状态
- 验证连接字符串
- 检查防火墙规则
- 查看数据库日志

#### 3. 上传文件失败
- 检查目录权限
- 验证磁盘空间
- 调整上传大小限制

### 日志查看

```bash
# 后端日志
tail -f /opt/star-savings/python_backend/logs/app.log

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 系统日志
journalctl -xe
```

## 安全建议

1. **定期更新**
   - 系统安全补丁
   - 依赖包更新
   - Docker镜像更新

2. **访问控制**
   - 限制SSH访问
   - 配置防火墙规则
   - 使用fail2ban防暴力破解

3. **数据安全**
   - 定期备份
   - 加密传输（HTTPS）
   - 敏感信息加密存储

4. **监控告警**
   - 异常登录告警
   - 资源使用告警
   - 错误率告警
