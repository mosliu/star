# 数据库设计文档

## 数据库概述

### 基本信息
- **数据库类型**: 关系型数据库
- **支持的数据库**: MySQL 8.0+ / SQLite 3.35+ / PostgreSQL 13+
- **ORM框架**: SQLAlchemy 2.0
- **迁移工具**: Alembic

### 设计原则
1. **数据一致性**: 使用事务保证关键操作的原子性
2. **性能优化**: 合理使用索引和冗余字段
3. **扩展性**: 预留字段，支持未来功能扩展
4. **安全性**: 敏感数据加密存储

## 数据表设计

### 1. children（小朋友表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| name | VARCHAR(100) | NOT NULL, INDEX | - | 小朋友姓名 |
| birthday | DATE | NULL | NULL | 生日 |
| gender | ENUM('boy', 'girl') | NOT NULL | 'boy' | 性别 |
| avatar | VARCHAR(255) | NULL | NULL | 头像URL |
| star_count | INTEGER | NOT NULL | 0 | 当前星星总数 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NULL | NULL | 更新时间 |
| deleted_at | DATETIME | NULL | NULL | 软删除时间 |

#### 索引设计
```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 姓名索引（用于搜索）
CREATE INDEX idx_children_name ON children(name);

-- 创建时间索引（用于排序）
CREATE INDEX idx_children_created_at ON children(created_at DESC);

-- 软删除索引（用于过滤）
CREATE INDEX idx_children_deleted_at ON children(deleted_at);
```

#### SQL创建语句
```sql
CREATE TABLE children (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    birthday DATE,
    gender ENUM('boy', 'girl') NOT NULL DEFAULT 'boy',
    avatar VARCHAR(255),
    star_count INTEGER NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME,
    INDEX idx_name (name),
    INDEX idx_created_at (created_at DESC),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2. star_records（星星记录表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| child_id | INTEGER | NOT NULL, FOREIGN KEY | - | 小朋友ID |
| amount | INTEGER | NOT NULL | - | 变动数量（正数加，负数减） |
| type | ENUM('add', 'subtract', 'redeem') | NOT NULL | - | 操作类型 |
| reason | VARCHAR(255) | NULL | NULL | 变动原因 |
| reward_id | INTEGER | NULL, FOREIGN KEY | NULL | 关联的奖品ID |
| operator | VARCHAR(100) | NULL | NULL | 操作人（预留） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### 索引设计
```sql
-- 主键索引
PRIMARY KEY (id)

-- 外键索引
CREATE INDEX idx_star_records_child_id ON star_records(child_id);
CREATE INDEX idx_star_records_reward_id ON star_records(reward_id);

-- 复合索引（用于查询特定小朋友的记录）
CREATE INDEX idx_star_records_child_created ON star_records(child_id, created_at DESC);

-- 类型索引（用于统计）
CREATE INDEX idx_star_records_type ON star_records(type);
```

#### SQL创建语句
```sql
CREATE TABLE star_records (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    child_id INTEGER NOT NULL,
    amount INTEGER NOT NULL,
    type ENUM('add', 'subtract', 'redeem') NOT NULL,
    reason VARCHAR(255),
    reward_id INTEGER,
    operator VARCHAR(100),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    FOREIGN KEY (reward_id) REFERENCES rewards(id) ON DELETE SET NULL,
    INDEX idx_child_id (child_id),
    INDEX idx_reward_id (reward_id),
    INDEX idx_child_created (child_id, created_at DESC),
    INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 3. rewards（奖品表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| name | VARCHAR(100) | NOT NULL | - | 奖品名称 |
| image | VARCHAR(255) | NULL | NULL | 奖品图片URL |
| required_stars | INTEGER | NOT NULL | - | 所需星星数 |
| description | TEXT | NULL | NULL | 奖品描述 |
| category | VARCHAR(50) | NULL | NULL | 奖品分类（预留） |
| is_redeemed | BOOLEAN | NOT NULL | FALSE | 是否已兑换 |
| redeemed_at | DATETIME | NULL | NULL | 兑换时间 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NULL | NULL | 更新时间 |
| deleted_at | DATETIME | NULL | NULL | 软删除时间 |

#### 索引设计
```sql
-- 主键索引
PRIMARY KEY (id)

-- 兑换状态索引
CREATE INDEX idx_rewards_is_redeemed ON rewards(is_redeemed);

-- 分类索引（预留）
CREATE INDEX idx_rewards_category ON rewards(category);

-- 创建时间索引
CREATE INDEX idx_rewards_created_at ON rewards(created_at DESC);
```

#### SQL创建语句
```sql
CREATE TABLE rewards (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    image VARCHAR(255),
    required_stars INTEGER NOT NULL,
    description TEXT,
    category VARCHAR(50),
    is_redeemed BOOLEAN NOT NULL DEFAULT FALSE,
    redeemed_at DATETIME,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME,
    INDEX idx_is_redeemed (is_redeemed),
    INDEX idx_category (category),
    INDEX idx_created_at (created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 4. reward_children（奖品-小朋友关联表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| reward_id | INTEGER | PRIMARY KEY, FOREIGN KEY | - | 奖品ID |
| child_id | INTEGER | PRIMARY KEY, FOREIGN KEY | - | 小朋友ID |
| deduction_amount | INTEGER | NULL | NULL | 兑换时实际扣除的星星数 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### 索引设计
```sql
-- 复合主键
PRIMARY KEY (reward_id, child_id)

-- 反向查询索引
CREATE INDEX idx_reward_children_child_id ON reward_children(child_id);
```

#### SQL创建语句
```sql
CREATE TABLE reward_children (
    reward_id INTEGER NOT NULL,
    child_id INTEGER NOT NULL,
    deduction_amount INTEGER,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (reward_id, child_id),
    FOREIGN KEY (reward_id) REFERENCES rewards(id) ON DELETE CASCADE,
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_child_id (child_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 5. users（用户表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | - | 用户名 |
| email | VARCHAR(100) | UNIQUE | NULL | 邮箱 |
| phone | VARCHAR(20) | UNIQUE | NULL | 手机号 |
| password_hash | VARCHAR(255) | NOT NULL | - | 密码哈希 |
| role | ENUM('child', 'parent', 'admin') | NOT NULL | 'parent' | 用户角色 |
| is_active | BOOLEAN | NOT NULL | TRUE | 是否激活 |
| is_verified | BOOLEAN | NOT NULL | FALSE | 是否验证 |
| last_login | DATETIME | NULL | NULL | 最后登录时间 |
| login_attempts | INTEGER | NOT NULL | 0 | 登录尝试次数 |
| locked_until | DATETIME | NULL | NULL | 锁定到期时间 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NULL | NULL | 更新时间 |

#### SQL创建语句
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('child', 'parent', 'admin') NOT NULL DEFAULT 'parent',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_verified BOOLEAN NOT NULL DEFAULT FALSE,
    last_login DATETIME,
    login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until DATETIME,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 6. user_children（用户-小朋友关联表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| user_id | INTEGER | PRIMARY KEY, FOREIGN KEY | - | 用户ID |
| child_id | INTEGER | PRIMARY KEY, FOREIGN KEY | - | 小朋友ID |
| relationship | VARCHAR(50) | NULL | NULL | 关系（父亲、母亲、监护人等） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### SQL创建语句
```sql
CREATE TABLE user_children (
    user_id INTEGER NOT NULL,
    child_id INTEGER NOT NULL,
    relationship VARCHAR(50),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, child_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_child_id (child_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 7. projects（项目表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| name | VARCHAR(100) | NOT NULL | - | 项目名称 |
| type | ENUM('add', 'subtract') | NOT NULL | - | 项目类型（加分/扣分） |
| value | INTEGER | NOT NULL | - | 分值 |
| category | VARCHAR(50) | NULL | NULL | 分类（学习、生活、运动等） |
| description | TEXT | NULL | NULL | 项目描述 |
| icon | VARCHAR(50) | NULL | NULL | 项目图标 |
| repeat_rule | VARCHAR(20) | NULL | 'unlimited' | 重复规则 |
| is_active | BOOLEAN | NOT NULL | TRUE | 是否启用 |
| created_by | INTEGER | NOT NULL, FOREIGN KEY | - | 创建人ID |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NULL | NULL | 更新时间 |

#### SQL创建语句
```sql
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type ENUM('add', 'subtract') NOT NULL,
    value INTEGER NOT NULL,
    category VARCHAR(50),
    description TEXT,
    icon VARCHAR(50),
    repeat_rule VARCHAR(20) DEFAULT 'unlimited',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_by INTEGER NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_type (type),
    INDEX idx_category (category),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 8. project_children（项目-小朋友关联表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| project_id | INTEGER | PRIMARY KEY, FOREIGN KEY | - | 项目ID |
| child_id | INTEGER | PRIMARY KEY, FOREIGN KEY | - | 小朋友ID |
| custom_value | INTEGER | NULL | NULL | 自定义分值（覆盖默认值） |
| is_enabled | BOOLEAN | NOT NULL | TRUE | 是否对该小朋友启用 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### SQL创建语句
```sql
CREATE TABLE project_children (
    project_id INTEGER NOT NULL,
    child_id INTEGER NOT NULL,
    custom_value INTEGER,
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (project_id, child_id),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_child_id (child_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 9. daily_summaries（每日总结表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| summary_date | DATE | NOT NULL, UNIQUE | - | 总结日期 |
| total_stars_earned | INTEGER | NOT NULL | 0 | 总获得星星 |
| total_stars_spent | INTEGER | NOT NULL | 0 | 总消费星星 |
| active_children | INTEGER | NOT NULL | 0 | 活跃小朋友数 |
| summary_data | JSON | NULL | NULL | 详细总结数据 |
| insights | TEXT | NULL | NULL | 洞察分析 |
| recommendations | TEXT | NULL | NULL | 建议 |
| generated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 生成时间 |

#### SQL创建语句
```sql
CREATE TABLE daily_summaries (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    summary_date DATE NOT NULL UNIQUE,
    total_stars_earned INTEGER NOT NULL DEFAULT 0,
    total_stars_spent INTEGER NOT NULL DEFAULT 0,
    active_children INTEGER NOT NULL DEFAULT 0,
    summary_data JSON,
    insights TEXT,
    recommendations TEXT,
    generated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_summary_date (summary_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 10. child_daily_stats（小朋友每日统计表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| child_id | INTEGER | NOT NULL, FOREIGN KEY | - | 小朋友ID |
| stat_date | DATE | NOT NULL | - | 统计日期 |
| stars_earned | INTEGER | NOT NULL | 0 | 当日获得星星 |
| stars_spent | INTEGER | NOT NULL | 0 | 当日消费星星 |
| tasks_completed | INTEGER | NOT NULL | 0 | 完成任务数 |
| behavior_score | INTEGER | NULL | NULL | 行为评分 |
| mood | VARCHAR(20) | NULL | NULL | 心情状态 |
| notes | TEXT | NULL | NULL | 备注 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### SQL创建语句
```sql
CREATE TABLE child_daily_stats (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    child_id INTEGER NOT NULL,
    stat_date DATE NOT NULL,
    stars_earned INTEGER NOT NULL DEFAULT 0,
    stars_spent INTEGER NOT NULL DEFAULT 0,
    tasks_completed INTEGER NOT NULL DEFAULT 0,
    behavior_score INTEGER,
    mood VARCHAR(20),
    notes TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_child_date (child_id, stat_date),
    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_stat_date (stat_date),
    INDEX idx_child_date (child_id, stat_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 11. sessions（会话表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | VARCHAR(100) | PRIMARY KEY | - | 会话ID |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | - | 用户ID |
| ip_address | VARCHAR(50) | NULL | NULL | IP地址 |
| user_agent | VARCHAR(255) | NULL | NULL | 用户代理 |
| device_type | VARCHAR(50) | NULL | NULL | 设备类型 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| expires_at | DATETIME | NOT NULL | - | 过期时间 |
| is_active | BOOLEAN | NOT NULL | TRUE | 是否活跃 |

#### SQL创建语句
```sql
CREATE TABLE sessions (
    id VARCHAR(100) PRIMARY KEY,
    user_id INTEGER NOT NULL,
    ip_address VARCHAR(50),
    user_agent VARCHAR(255),
    device_type VARCHAR(50),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 12. audit_logs（审计日志表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| user_id | INTEGER | NULL, FOREIGN KEY | NULL | 用户ID |
| action | VARCHAR(100) | NOT NULL | - | 操作类型 |
| target_type | VARCHAR(50) | NULL | NULL | 目标类型 |
| target_id | INTEGER | NULL | NULL | 目标ID |
| old_value | JSON | NULL | NULL | 旧值 |
| new_value | JSON | NULL | NULL | 新值 |
| ip_address | VARCHAR(50) | NULL | NULL | IP地址 |
| user_agent | VARCHAR(255) | NULL | NULL | 用户代理 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### SQL创建语句
```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER,
    action VARCHAR(100) NOT NULL,
    target_type VARCHAR(50),
    target_id INTEGER,
    old_value JSON,
    new_value JSON,
    ip_address VARCHAR(50),
    user_agent VARCHAR(255),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_target (target_type, target_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 13. notifications（通知表）

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | - | 用户ID |
| type | VARCHAR(50) | NOT NULL | - | 通知类型 |
| title | VARCHAR(200) | NOT NULL | - | 标题 |
| content | TEXT | NOT NULL | - | 内容 |
| is_read | BOOLEAN | NOT NULL | FALSE | 是否已读 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

#### SQL创建语句
```sql
CREATE TABLE notifications (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    is_read BOOLEAN NOT NULL DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_is_read (is_read),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 扩展表设计（计划中）

### tasks（任务表）- 计划中

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| title | VARCHAR(100) | NOT NULL | - | 任务标题 |
| description | TEXT | NULL | NULL | 任务描述 |
| star_reward | INTEGER | NOT NULL | - | 完成奖励星星数 |
| child_id | INTEGER | NULL, FOREIGN KEY | NULL | 指定的小朋友 |
| is_completed | BOOLEAN | NOT NULL | FALSE | 是否完成 |
| completed_at | DATETIME | NULL | NULL | 完成时间 |

### 7. achievements（成就表）- 计划中

#### 表结构
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 主键ID |
| name | VARCHAR(100) | NOT NULL | - | 成就名称 |
| icon | VARCHAR(255) | NULL | NULL | 成就图标 |
| requirement | TEXT | NOT NULL | - | 达成条件描述 |
| star_bonus | INTEGER | NOT NULL | 0 | 达成奖励星星数 |

## 数据关系图

```mermaid
erDiagram
    children ||--o{ star_records : has
    children ||--o{ reward_children : participates
    rewards ||--o{ reward_children : includes
    rewards ||--o{ star_records : redeemed_in
    
    children {
        int id PK
        string name
        date birthday
        enum gender
        string avatar
        int star_count
        datetime created_at
    }
    
    star_records {
        int id PK
        int child_id FK
        int amount
        enum type
        string reason
        int reward_id FK
        datetime created_at
    }
    
    rewards {
        int id PK
        string name
        string image
        int required_stars
        text description
        boolean is_redeemed
        datetime redeemed_at
    }
    
    reward_children {
        int reward_id PK-FK
        int child_id PK-FK
        int deduction_amount
        datetime created_at
    }
```

## 数据操作规范

### 1. 事务处理

#### 星星变动事务
```sql
START TRANSACTION;

-- 插入星星记录
INSERT INTO star_records (child_id, amount, type, reason) 
VALUES (1, 10, 'add', '完成作业');

-- 更新小朋友星星总数
UPDATE children 
SET star_count = star_count + 10 
WHERE id = 1;

COMMIT;
```

#### 奖品兑换事务
```sql
START TRANSACTION;

-- 检查星星余额
SELECT star_count FROM children WHERE id IN (1, 2) FOR UPDATE;

-- 插入兑换记录
INSERT INTO star_records (child_id, amount, type, reason, reward_id)
VALUES 
    (1, -60, 'redeem', '兑换乐高积木', 1),
    (2, -40, 'redeem', '兑换乐高积木', 1);

-- 更新星星余额
UPDATE children SET star_count = star_count - 60 WHERE id = 1;
UPDATE children SET star_count = star_count - 40 WHERE id = 2;

-- 更新关联表
UPDATE reward_children 
SET deduction_amount = 60 
WHERE reward_id = 1 AND child_id = 1;

UPDATE reward_children 
SET deduction_amount = 40 
WHERE reward_id = 1 AND child_id = 2;

-- 标记奖品为已兑换
UPDATE rewards 
SET is_redeemed = TRUE, redeemed_at = NOW() 
WHERE id = 1;

COMMIT;
```

### 2. 查询优化

#### 使用JOIN减少查询次数
```sql
-- 获取奖品及其关联的小朋友信息
SELECT 
    r.*,
    c.id as child_id,
    c.name as child_name,
    c.star_count,
    rc.deduction_amount
FROM rewards r
LEFT JOIN reward_children rc ON r.id = rc.reward_id
LEFT JOIN children c ON rc.child_id = c.id
WHERE r.is_redeemed = FALSE
ORDER BY r.created_at DESC;
```

#### 使用子查询优化统计
```sql
-- 获取每个小朋友的统计信息
SELECT 
    c.*,
    (SELECT COUNT(*) FROM star_records WHERE child_id = c.id AND type = 'add') as add_count,
    (SELECT SUM(amount) FROM star_records WHERE child_id = c.id AND type = 'add') as total_earned,
    (SELECT COUNT(*) FROM reward_children rc 
     JOIN rewards r ON rc.reward_id = r.id 
     WHERE rc.child_id = c.id AND r.is_redeemed = TRUE) as rewards_redeemed
FROM children c
WHERE c.deleted_at IS NULL;
```

### 3. 数据维护

#### 定期清理历史数据
```sql
-- 删除90天前的星星记录（保留汇总）
DELETE FROM star_records 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
AND type != 'redeem';

-- 归档已兑换的奖品
INSERT INTO rewards_archive 
SELECT * FROM rewards 
WHERE is_redeemed = TRUE 
AND redeemed_at < DATE_SUB(NOW(), INTERVAL 180 DAY);

DELETE FROM rewards 
WHERE is_redeemed = TRUE 
AND redeemed_at < DATE_SUB(NOW(), INTERVAL 180 DAY);
```

#### 数据一致性检查
```sql
-- 检查星星总数是否与记录一致
SELECT 
    c.id,
    c.name,
    c.star_count as current_count,
    COALESCE(SUM(sr.amount), 0) as calculated_count,
    c.star_count - COALESCE(SUM(sr.amount), 0) as difference
FROM children c
LEFT JOIN star_records sr ON c.id = sr.child_id
GROUP BY c.id
HAVING difference != 0;

-- 修复不一致的数据
UPDATE children c
SET c.star_count = (
    SELECT COALESCE(SUM(amount), 0) 
    FROM star_records 
    WHERE child_id = c.id
)
WHERE c.id IN (/* 不一致的ID列表 */);
```

## 性能优化建议

### 1. 索引优化
- 定期分析查询模式，添加必要的索引
- 避免过多索引影响写入性能
- 使用复合索引优化多条件查询

### 2. 查询优化
- 使用EXPLAIN分析查询计划
- 避免SELECT *，只查询需要的字段
- 使用LIMIT限制返回记录数
- 合理使用缓存减少数据库压力

### 3. 表优化
- 定期执行ANALYZE TABLE更新统计信息
- 使用分区表处理大量历史数据
- 考虑读写分离架构

### 4. 连接池配置
```python
# SQLAlchemy连接池配置
engine = create_engine(
    DATABASE_URL,
    pool_size=20,        # 连接池大小
    max_overflow=40,     # 最大溢出连接数
    pool_timeout=30,     # 连接超时时间
    pool_recycle=3600,   # 连接回收时间
    pool_pre_ping=True   # 连接健康检查
)
```

## 备份恢复策略

### 1. 备份策略
- 全量备份：每天凌晨2点
- 增量备份：每小时
- 事务日志：实时

### 2. 备份脚本
```bash
#!/bin/bash
# 全量备份
mysqldump -u root -p --single-transaction --routines --triggers --databases star_db > backup_$(date +%Y%m%d).sql

# 增量备份（使用binlog）
mysqlbinlog --start-datetime="2024-01-01 00:00:00" /var/lib/mysql/binlog.000001 > incremental_backup.sql
```

### 3. 恢复流程
```bash
# 恢复全量备份
mysql -u root -p star_db < backup_20240101.sql

# 应用增量备份
mysql -u root -p star_db < incremental_backup.sql
```

## 数据安全

### 1. 访问控制
```sql
-- 创建应用用户
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'strong_password';

-- 授予必要权限
GRANT SELECT, INSERT, UPDATE, DELETE ON star_db.* TO 'app_user'@'localhost';

-- 创建只读用户（用于报表）
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'password';
GRANT SELECT ON star_db.* TO 'readonly_user'@'%';
```

### 2. 数据加密
- 使用TLS/SSL加密传输
- 敏感字段加密存储
- 定期更换数据库密码

### 3. 审计日志
```sql
-- 创建审计表
CREATE TABLE audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    table_name VARCHAR(50),
    operation ENUM('INSERT', 'UPDATE', 'DELETE'),
    user VARCHAR(100),
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    old_values JSON,
    new_values JSON
);
```
