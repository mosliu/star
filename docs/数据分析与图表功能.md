# 数据分析与图表功能设计文档

## 概述

数据分析与图表功能为家长提供深入的数据洞察，通过可视化的方式展示小朋友的成长轨迹、行为模式和进步情况。系统自动生成每日总结，并提供丰富的图表和报表功能。

## 核心功能模块

### 1. 每日总结系统

#### 自动生成机制
```python
class DailySummaryGenerator:
    """每日总结生成器"""
    
    def __init__(self, db: Session):
        self.db = db
        
    def generate_daily_summary(self, date: datetime.date):
        """生成指定日期的总结"""
        summary = {
            "date": date,
            "children_summaries": [],
            "overall_analysis": {},
            "recommendations": [],
            "highlights": []
        }
        
        # 获取所有小朋友的当日数据
        children = self.db.query(Child).filter(Child.is_active == True).all()
        
        for child in children:
            child_summary = self._generate_child_summary(child, date)
            summary["children_summaries"].append(child_summary)
        
        # 生成整体分析
        summary["overall_analysis"] = self._analyze_overall_performance(
            summary["children_summaries"]
        )
        
        # 生成建议
        summary["recommendations"] = self._generate_recommendations(
            summary["children_summaries"]
        )
        
        # 提取亮点
        summary["highlights"] = self._extract_highlights(
            summary["children_summaries"]
        )
        
        return summary
    
    def _generate_child_summary(self, child: Child, date: datetime.date):
        """生成单个小朋友的日总结"""
        # 获取当日星星记录
        records = self.db.query(StarRecord).filter(
            StarRecord.child_id == child.id,
            func.date(StarRecord.created_at) == date
        ).all()
        
        return {
            "child_id": child.id,
            "child_name": child.name,
            "star_changes": self._calculate_star_changes(records),
            "completed_projects": self._get_completed_projects(records),
            "behavior_analysis": self._analyze_behavior(records),
            "progress_indicator": self._calculate_progress(child, date),
            "notable_events": self._extract_notable_events(records)
        }
```

#### 每日总结内容结构
```typescript
interface DailySummary {
  date: string
  children: ChildDailySummary[]
  overall: {
    totalStarsEarned: number
    totalStarsSpent: number
    mostActiveChild: string
    bestPerformer: string
    areasOfImprovement: string[]
  }
  insights: {
    trend: 'improving' | 'stable' | 'declining'
    keyObservations: string[]
    parentingTips: string[]
  }
  tomorrow: {
    goals: Goal[]
    reminders: string[]
    suggestedActivities: Activity[]
  }
}

interface ChildDailySummary {
  name: string
  avatar: string
  starChanges: {
    earned: number
    spent: number
    net: number
  }
  achievements: Achievement[]
  completedTasks: Task[]
  behaviorScore: number
  mood: 'happy' | 'normal' | 'needs_attention'
  parentNotes: string
}
```

#### 每日总结展示界面
```vue
<template>
  <div class="daily-summary">
    <!-- 日期选择器 -->
    <el-date-picker
      v-model="selectedDate"
      type="date"
      placeholder="选择日期"
      @change="loadSummary"
    />
    
    <!-- 总结头部 -->
    <div class="summary-header">
      <h1>{{ formatDate(selectedDate) }} 每日总结</h1>
      <div class="quick-stats">
        <div class="stat-card">
          <i class="el-icon-star-on"></i>
          <span>总计获得 {{ summary.overall.totalStarsEarned }} 颗星星</span>
        </div>
        <div class="stat-card">
          <i class="el-icon-trophy"></i>
          <span>今日之星：{{ summary.overall.bestPerformer }}</span>
        </div>
      </div>
    </div>
    
    <!-- 小朋友个人总结 -->
    <div class="children-summaries">
      <el-card v-for="child in summary.children" :key="child.name">
        <div class="child-summary">
          <div class="child-header">
            <img :src="child.avatar" :alt="child.name">
            <h3>{{ child.name }}</h3>
            <el-tag :type="getMoodType(child.mood)">
              {{ getMoodText(child.mood) }}
            </el-tag>
          </div>
          
          <div class="star-summary">
            <div class="star-item earned">
              <span class="label">获得</span>
              <span class="value">+{{ child.starChanges.earned }}</span>
            </div>
            <div class="star-item spent">
              <span class="label">使用</span>
              <span class="value">-{{ child.starChanges.spent }}</span>
            </div>
            <div class="star-item net">
              <span class="label">净值</span>
              <span class="value" :class="{ positive: child.starChanges.net > 0 }">
                {{ child.starChanges.net > 0 ? '+' : '' }}{{ child.starChanges.net }}
              </span>
            </div>
          </div>
          
          <div class="achievements" v-if="child.achievements.length">
            <h4>今日成就</h4>
            <el-tag v-for="achievement in child.achievements" :key="achievement.id">
              {{ achievement.name }}
            </el-tag>
          </div>
          
          <div class="behavior-score">
            <h4>行为评分</h4>
            <el-progress
              :percentage="child.behaviorScore"
              :color="getScoreColor(child.behaviorScore)"
            />
          </div>
        </div>
      </el-card>
    </div>
    
    <!-- 洞察与建议 -->
    <div class="insights-section">
      <h2>今日洞察</h2>
      <ul>
        <li v-for="observation in summary.insights.keyObservations">
          {{ observation }}
        </li>
      </ul>
      
      <h2>教育建议</h2>
      <ul>
        <li v-for="tip in summary.insights.parentingTips">
          {{ tip }}
        </li>
      </ul>
    </div>
    
    <!-- 明日计划 -->
    <div class="tomorrow-plan">
      <h2>明日计划</h2>
      <div class="goals">
        <div v-for="goal in summary.tomorrow.goals" :key="goal.id">
          <el-checkbox v-model="goal.scheduled">
            {{ goal.description }}
          </el-checkbox>
        </div>
      </div>
    </div>
    
    <!-- 导出和分享 -->
    <div class="actions">
      <el-button @click="exportPDF">导出PDF</el-button>
      <el-button @click="shareReport">分享报告</el-button>
      <el-button @click="saveNotes">保存备注</el-button>
    </div>
  </div>
</template>
```

### 2. 数据图表系统

#### 图表类型与用途

##### 2.1 星星趋势图
```javascript
// 星星变化趋势配置
const starTrendChart = {
  type: 'line',
  title: '星星变化趋势',
  options: {
    xAxis: {
      type: 'category',
      data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
    },
    yAxis: {
      type: 'value',
      name: '星星数量'
    },
    series: [
      {
        name: '小明',
        type: 'line',
        smooth: true,
        data: [120, 132, 101, 134, 90, 230, 210],
        itemStyle: { color: '#5470c6' }
      },
      {
        name: '小红',
        type: 'line',
        smooth: true,
        data: [220, 182, 191, 234, 290, 330, 310],
        itemStyle: { color: '#91cc75' }
      }
    ],
    tooltip: {
      trigger: 'axis',
      formatter: '{b}<br/>{a0}: {c0}<br/>{a1}: {c1}'
    }
  }
}
```

##### 2.2 行为分布图
```javascript
// 行为类别分布
const behaviorChart = {
  type: 'pie',
  title: '行为类别分布',
  options: {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      left: 'left'
    },
    series: [
      {
        name: '行为类别',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: '20',
            fontWeight: 'bold'
          }
        },
        data: [
          { value: 45, name: '学习', itemStyle: { color: '#5470c6' } },
          { value: 30, name: '生活', itemStyle: { color: '#91cc75' } },
          { value: 15, name: '运动', itemStyle: { color: '#fac858' } },
          { value: 10, name: '社交', itemStyle: { color: '#ee6666' } }
        ]
      }
    ]
  }
}
```

##### 2.3 对比分析雷达图
```javascript
// 多维度能力对比
const radarChart = {
  type: 'radar',
  title: '综合能力对比',
  options: {
    legend: {
      data: ['小明', '小红', '平均水平']
    },
    radar: {
      indicator: [
        { name: '学习能力', max: 100 },
        { name: '生活自理', max: 100 },
        { name: '社交能力', max: 100 },
        { name: '运动能力', max: 100 },
        { name: '创造力', max: 100 },
        { name: '责任心', max: 100 }
      ],
      shape: 'polygon'
    },
    series: [
      {
        name: '能力对比',
        type: 'radar',
        data: [
          {
            value: [85, 78, 90, 72, 88, 80],
            name: '小明',
            areaStyle: { color: 'rgba(84, 112, 198, 0.3)' }
          },
          {
            value: [78, 85, 75, 88, 76, 92],
            name: '小红',
            areaStyle: { color: 'rgba(145, 204, 117, 0.3)' }
          },
          {
            value: [70, 70, 70, 70, 70, 70],
            name: '平均水平',
            lineStyle: { type: 'dashed' }
          }
        ]
      }
    ]
  }
}
```

##### 2.4 热力图
```javascript
// 活动热力图
const heatmapChart = {
  type: 'heatmap',
  title: '每日活动热力图',
  options: {
    tooltip: {
      position: 'top'
    },
    grid: {
      height: '50%',
      top: '10%'
    },
    xAxis: {
      type: 'category',
      data: ['00:00', '06:00', '12:00', '18:00', '24:00'],
      splitArea: { show: true }
    },
    yAxis: {
      type: 'category',
      data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
      splitArea: { show: true }
    },
    visualMap: {
      min: 0,
      max: 10,
      calculable: true,
      orient: 'horizontal',
      left: 'center',
      bottom: '15%',
      inRange: {
        color: ['#f0f0f0', '#ffd700', '#ff4500']
      }
    },
    series: [{
      name: '活动频率',
      type: 'heatmap',
      data: generateHeatmapData(),
      label: { show: true },
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }]
  }
}
```

### 3. 统计报表功能

#### 报表类型

##### 3.1 周报生成
```python
class WeeklyReportGenerator:
    """周报生成器"""
    
    def generate_weekly_report(self, start_date: datetime.date):
        """生成周报"""
        end_date = start_date + timedelta(days=6)
        
        report = {
            "period": f"{start_date} 至 {end_date}",
            "summary": self._generate_weekly_summary(start_date, end_date),
            "children_reports": self._generate_children_reports(start_date, end_date),
            "achievements": self._get_weekly_achievements(start_date, end_date),
            "challenges": self._identify_challenges(start_date, end_date),
            "recommendations": self._generate_recommendations(start_date, end_date)
        }
        
        return report
    
    def _generate_weekly_summary(self, start_date, end_date):
        """生成周总结"""
        return {
            "total_stars_earned": self._calculate_total_stars(start_date, end_date, "add"),
            "total_stars_spent": self._calculate_total_stars(start_date, end_date, "subtract"),
            "rewards_redeemed": self._count_rewards_redeemed(start_date, end_date),
            "most_improved_child": self._find_most_improved(start_date, end_date),
            "weekly_goals_completion": self._calculate_goals_completion(start_date, end_date)
        }
```

##### 3.2 月报模板
```vue
<template>
  <div class="monthly-report">
    <div class="report-header">
      <h1>{{ month }}月成长报告</h1>
      <p class="subtitle">记录孩子们的点滴进步</p>
    </div>
    
    <!-- 月度统计卡片 -->
    <el-row :gutter="20" class="stats-cards">
      <el-col :span="6">
        <el-card>
          <div class="stat-item">
            <div class="stat-value">{{ monthlyStats.totalStars }}</div>
            <div class="stat-label">总星星数</div>
            <div class="stat-trend" :class="getTrendClass(monthlyStats.starsTrend)">
              <i :class="getTrendIcon(monthlyStats.starsTrend)"></i>
              {{ monthlyStats.starsTrend }}%
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card>
          <div class="stat-item">
            <div class="stat-value">{{ monthlyStats.completedTasks }}</div>
            <div class="stat-label">完成任务</div>
            <div class="stat-progress">
              <el-progress :percentage="monthlyStats.taskCompletionRate" />
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card>
          <div class="stat-item">
            <div class="stat-value">{{ monthlyStats.redeemedRewards }}</div>
            <div class="stat-label">兑换奖品</div>
            <div class="stat-list">
              <span v-for="reward in monthlyStats.topRewards" :key="reward.id">
                {{ reward.name }}
              </span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card>
          <div class="stat-item">
            <div class="stat-value">{{ monthlyStats.activeDays }}</div>
            <div class="stat-label">活跃天数</div>
            <div class="stat-calendar">
              <div 
                v-for="day in 30" 
                :key="day"
                class="calendar-day"
                :class="{ active: isActiveDay(day) }"
              ></div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 个人月度报告 -->
    <div class="individual-reports">
      <el-tabs v-model="activeChild">
        <el-tab-pane 
          v-for="child in children" 
          :key="child.id"
          :label="child.name"
          :name="child.id"
        >
          <ChildMonthlyReport :child="child" :month="month" />
        </el-tab-pane>
      </el-tabs>
    </div>
    
    <!-- 月度排行榜 -->
    <div class="monthly-rankings">
      <h2>月度排行榜</h2>
      <el-table :data="rankings" style="width: 100%">
        <el-table-column prop="rank" label="排名" width="80">
          <template #default="{row}">
            <div class="rank-badge" :class="`rank-${row.rank}`">
              {{ row.rank }}
            </div>
          </template>
        </el-table-column>
        <el-table-column prop="name" label="姓名" />
        <el-table-column prop="totalStars" label="总星星" />
        <el-table-column prop="tasksCompleted" label="完成任务" />
        <el-table-column prop="score" label="综合得分">
          <template #default="{row}">
            <el-progress 
              :percentage="row.score" 
              :color="getScoreColor(row.score)"
            />
          </template>
        </el-table-column>
      </el-table>
    </div>
    
    <!-- 家长寄语 -->
    <div class="parent-message">
      <h2>家长寄语</h2>
      <el-input
        v-model="parentMessage"
        type="textarea"
        :rows="4"
        placeholder="写下对孩子们的鼓励和期望..."
      />
    </div>
    
    <!-- 导出操作 -->
    <div class="export-actions">
      <el-button type="primary" @click="exportPDF">
        <i class="el-icon-download"></i> 导出PDF
      </el-button>
      <el-button @click="printReport">
        <i class="el-icon-printer"></i> 打印报告
      </el-button>
      <el-button @click="shareReport">
        <i class="el-icon-share"></i> 分享报告
      </el-button>
    </div>
  </div>
</template>
```

### 4. 数据分析算法

#### 4.1 行为模式识别
```python
class BehaviorAnalyzer:
    """行为模式分析器"""
    
    def analyze_behavior_patterns(self, child_id: int, period_days: int = 30):
        """分析行为模式"""
        records = self._get_star_records(child_id, period_days)
        
        patterns = {
            "peak_activity_time": self._find_peak_activity_time(records),
            "consistent_behaviors": self._find_consistent_behaviors(records),
            "improvement_areas": self._identify_improvement_areas(records),
            "strength_areas": self._identify_strengths(records),
            "behavior_trends": self._analyze_trends(records)
        }
        
        return patterns
    
    def _find_peak_activity_time(self, records):
        """找出活跃时间段"""
        hour_distribution = {}
        for record in records:
            hour = record.created_at.hour
            hour_distribution[hour] = hour_distribution.get(hour, 0) + 1
        
        peak_hour = max(hour_distribution, key=hour_distribution.get)
        return {
            "peak_hour": peak_hour,
            "distribution": hour_distribution
        }
    
    def _find_consistent_behaviors(self, records):
        """找出持续性行为"""
        behavior_frequency = {}
        for record in records:
            if record.project_id:
                behavior_frequency[record.project_id] = \
                    behavior_frequency.get(record.project_id, 0) + 1
        
        # 找出频率高的行为
        consistent = [
            project_id for project_id, count in behavior_frequency.items()
            if count >= len(set(r.created_at.date() for r in records)) * 0.7
        ]
        
        return consistent
```

#### 4.2 进步评估算法
```python
def calculate_progress_score(child_id: int, period: str = "week"):
    """计算进步分数"""
    current_period_stats = get_period_stats(child_id, "current", period)
    previous_period_stats = get_period_stats(child_id, "previous", period)
    
    # 计算各项指标的进步
    star_progress = (
        current_period_stats["stars"] - previous_period_stats["stars"]
    ) / max(previous_period_stats["stars"], 1) * 100
    
    task_progress = (
        current_period_stats["tasks"] - previous_period_stats["tasks"]
    ) / max(previous_period_stats["tasks"], 1) * 100
    
    behavior_progress = (
        current_period_stats["behavior_score"] - 
        previous_period_stats["behavior_score"]
    )
    
    # 综合进步分数
    progress_score = (
        star_progress * 0.3 +
        task_progress * 0.3 +
        behavior_progress * 0.4
    )
    
    return {
        "overall_score": progress_score,
        "star_progress": star_progress,
        "task_progress": task_progress,
        "behavior_progress": behavior_progress,
        "trend": "improving" if progress_score > 0 else "declining"
    }
```

### 5. 数据导出功能

#### 5.1 PDF导出
```python
from reportlab.lib import colors
from reportlab.lib.pagesizes import letter, A4
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph
from reportlab.lib.styles import getSampleStyleSheet

class PDFReportGenerator:
    """PDF报告生成器"""
    
    def generate_report(self, report_data: dict, filename: str):
        """生成PDF报告"""
        doc = SimpleDocTemplate(filename, pagesize=A4)
        story = []
        styles = getSampleStyleSheet()
        
        # 标题
        title = Paragraph(report_data["title"], styles['Title'])
        story.append(title)
        
        # 统计数据表格
        table_data = self._prepare_table_data(report_data["stats"])
        table = Table(table_data)
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 14),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black)
        ]))
        story.append(table)
        
        # 图表（转换为图片）
        for chart in report_data["charts"]:
            chart_image = self._convert_chart_to_image(chart)
            story.append(chart_image)
        
        # 生成PDF
        doc.build(story)
```

#### 5.2 Excel导出
```python
import pandas as pd
from openpyxl import Workbook
from openpyxl.chart import LineChart, Reference
from openpyxl.styles import Font, PatternFill, Alignment

class ExcelReportGenerator:
    """Excel报告生成器"""
    
    def generate_report(self, report_data: dict, filename: str):
        """生成Excel报告"""
        wb = Workbook()
        
        # 概览页
        ws_summary = wb.active
        ws_summary.title = "概览"
        self._create_summary_sheet(ws_summary, report_data["summary"])
        
        # 详细数据页
        ws_details = wb.create_sheet("详细数据")
        self._create_details_sheet(ws_details, report_data["details"])
        
        # 图表页
        ws_charts = wb.create_sheet("图表")
        self._create_charts_sheet(ws_charts, report_data["chart_data"])
        
        # 保存文件
        wb.save(filename)
    
    def _create_summary_sheet(self, ws, summary_data):
        """创建概览页"""
        # 设置标题
        ws['A1'] = "月度总结报告"
        ws['A1'].font = Font(size=16, bold=True)
        
        # 添加统计数据
        headers = ['指标', '数值', '环比', '同比']
        ws.append(headers)
        
        for row in summary_data:
            ws.append(row)
        
        # 设置样式
        for cell in ws[2]:
            cell.font = Font(bold=True)
            cell.fill = PatternFill(start_color="366092", 
                                   end_color="366092", 
                                   fill_type="solid")
```

## 实时数据处理

### WebSocket推送
```python
from fastapi import WebSocket
from typing import List
import asyncio

class DataBroadcaster:
    """实时数据广播器"""
    
    def __init__(self):
        self.connections: List[WebSocket] = []
        
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.connections.append(websocket)
        
    def disconnect(self, websocket: WebSocket):
        self.connections.remove(websocket)
        
    async def broadcast_star_update(self, update_data):
        """广播星星更新"""
        message = {
            "type": "star_update",
            "data": update_data,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        for connection in self.connections:
            try:
                await connection.send_json(message)
            except:
                self.disconnect(connection)
    
    async def broadcast_daily_summary(self, summary):
        """广播每日总结"""
        message = {
            "type": "daily_summary",
            "data": summary,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        for connection in self.connections:
            try:
                await connection.send_json(message)
            except:
                self.disconnect(connection)

# WebSocket端点
@app.websocket("/ws/analytics")
async def websocket_endpoint(websocket: WebSocket):
    await broadcaster.connect(websocket)
    try:
        while True:
            await asyncio.sleep(1)
    except WebSocketDisconnect:
        broadcaster.disconnect(websocket)
```

## 性能优化策略

### 1. 数据缓存
```python
from functools import lru_cache
import redis

class AnalyticsCache:
    """分析数据缓存"""
    
    def __init__(self):
        self.redis_client = redis.Redis(host='localhost', port=6379, db=0)
        
    def get_cached_report(self, report_key: str):
        """获取缓存的报告"""
        cached = self.redis_client.get(report_key)
        if cached:
            return json.loads(cached)
        return None
    
    def cache_report(self, report_key: str, report_data: dict, ttl: int = 3600):
        """缓存报告"""
        self.redis_client.setex(
            report_key,
            ttl,
            json.dumps(report_data)
        )
    
    @lru_cache(maxsize=128)
    def get_chart_data(self, child_id: int, chart_type: str, period: str):
        """获取图表数据（内存缓存）"""
        return generate_chart_data(child_id, chart_type, period)
```

### 2. 异步数据处理
```python
import asyncio
from celery import Celery

celery_app = Celery('analytics', broker='redis://localhost:6379')

@celery_app.task
def generate_daily_summary_task(date: str):
    """异步生成每日总结"""
    generator = DailySummaryGenerator()
    summary = generator.generate_daily_summary(date)
    
    # 保存到数据库
    save_summary_to_db(summary)
    
    # 发送通知
    send_summary_notifications(summary)
    
    return summary

# 定时任务
@celery_app.task
def scheduled_report_generation():
    """定时生成报告"""
    # 每天凌晨2点生成前一天的总结
    yesterday = datetime.now().date() - timedelta(days=1)
    generate_daily_summary_task.delay(str(yesterday))
```

## 用户界面优化

### 1. 交互式图表
- 支持缩放和平移
- 数据点悬停提示
- 点击钻取详情
- 实时数据更新动画

### 2. 响应式设计
- 移动端图表自适应
- 触摸手势支持
- 横竖屏切换适配
- 离线数据缓存

### 3. 个性化设置
- 自定义图表颜色主题
- 选择默认显示的图表
- 设置数据更新频率
- 订阅特定类型的报告
