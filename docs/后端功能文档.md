# 后端功能文档

## 技术架构

### 核心框架
- **FastAPI**: 现代化的Python Web框架
- **Python 3.11+**: 最新的Python版本
- **SQLAlchemy**: 强大的ORM框架
- **Pydantic**: 数据验证和序列化
- **Alembic**: 数据库迁移工具
- **Uvicorn**: ASGI服务器

### 项目结构

```
python_backend/
├── app/
│   ├── api/
│   │   └── endpoints/
│   │       ├── children.py    # 小朋友相关接口
│   │       ├── rewards.py     # 奖品相关接口
│   │       └── stars.py       # 星星操作接口
│   ├── core/
│   │   ├── config.py          # 配置管理
│   │   ├── database.py        # 数据库连接
│   │   └── deps.py            # 依赖注入
│   ├── models/
│   │   ├── child.py           # 小朋友模型
│   │   ├── reward.py          # 奖品模型
│   │   └── star_record.py     # 星星记录模型
│   └── schemas/
│       ├── child.py           # 小朋友数据架构
│       ├── reward.py          # 奖品数据架构
│       └── star.py            # 星星数据架构
├── alembic/                    # 数据库迁移
│   ├── versions/               # 迁移版本文件
│   └── env.py                  # 迁移环境配置
├── logs/                       # 日志文件
├── uploads/                    # 上传文件存储
├── main.py                     # 应用入口
├── init_db.py                  # 数据库初始化
├── requirements.txt            # 依赖包列表
└── .env                        # 环境变量配置
```

## 数据模型设计

### 1. Child Model (小朋友模型)

```python
class Child(Base):
    __tablename__ = "children"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    birthday = Column(Date, nullable=True)
    gender = Column(Enum(Gender), nullable=False)
    avatar = Column(String(255), nullable=True)
    star_count = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    
    # 关系
    star_records = relationship("StarRecord", back_populates="child", cascade="all, delete-orphan")
    rewards = relationship("Reward", secondary="reward_children", back_populates="children")
```

**字段说明**：
- `id`: 自增主键
- `name`: 小朋友姓名
- `birthday`: 生日，用于计算年龄
- `gender`: 性别枚举（boy/girl）
- `avatar`: 头像URL路径
- `star_count`: 当前星星总数（冗余字段，提升查询性能）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. StarRecord Model (星星记录模型)

```python
class StarRecord(Base):
    __tablename__ = "star_records"
    
    id = Column(Integer, primary_key=True, index=True)
    child_id = Column(Integer, ForeignKey("children.id"), nullable=False)
    amount = Column(Integer, nullable=False)
    type = Column(Enum(StarType), nullable=False)  # add/subtract/redeem
    reason = Column(String(255), nullable=True)
    reward_id = Column(Integer, ForeignKey("rewards.id"), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # 关系
    child = relationship("Child", back_populates="star_records")
    reward = relationship("Reward")
```

**字段说明**：
- `type`: 操作类型
  - `add`: 增加星星
  - `subtract`: 减少星星
  - `redeem`: 兑换消费
- `reason`: 操作原因描述
- `reward_id`: 兑换时关联的奖品ID

### 3. Reward Model (奖品模型)

```python
class Reward(Base):
    __tablename__ = "rewards"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    image = Column(String(255), nullable=True)
    required_stars = Column(Integer, nullable=False)
    description = Column(Text, nullable=True)
    is_redeemed = Column(Boolean, default=False)
    redeemed_at = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # 关系
    children = relationship("Child", secondary="reward_children", back_populates="rewards")
    redemption_records = relationship("RewardChild", back_populates="reward")
```

### 4. RewardChild Model (关联表)

```python
class RewardChild(Base):
    __tablename__ = "reward_children"
    
    reward_id = Column(Integer, ForeignKey("rewards.id"), primary_key=True)
    child_id = Column(Integer, ForeignKey("children.id"), primary_key=True)
    deduction_amount = Column(Integer, nullable=True)  # 兑换时的实际扣除数
    
    # 关系
    reward = relationship("Reward", back_populates="redemption_records")
    child = relationship("Child")
```

## API接口实现

### 1. 小朋友管理接口

#### GET /api/children - 获取小朋友列表
```python
@router.get("/", response_model=List[ChildResponse])
def get_children(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    children = db.query(Child).offset(skip).limit(limit).all()
    return children
```

**功能特性**：
- 支持分页查询
- 返回完整的小朋友信息
- 包含当前星星数量

#### GET /api/children/{child_id} - 获取小朋友详情
```python
@router.get("/{child_id}", response_model=ChildDetailResponse)
def get_child(child_id: int, db: Session = Depends(get_db)):
    child = db.query(Child).filter(Child.id == child_id).first()
    if not child:
        raise HTTPException(status_code=404, detail="Child not found")
    
    # 获取最近的星星记录
    recent_records = db.query(StarRecord)\
        .filter(StarRecord.child_id == child_id)\
        .order_by(StarRecord.created_at.desc())\
        .limit(20)\
        .all()
    
    return {
        **child.__dict__,
        "recent_records": recent_records
    }
```

#### POST /api/children - 创建小朋友
```python
@router.post("/", response_model=ChildResponse)
def create_child(
    child: ChildCreate,
    db: Session = Depends(get_db)
):
    db_child = Child(**child.dict())
    db.add(db_child)
    db.commit()
    db.refresh(db_child)
    
    # 处理头像上传
    if child.avatar:
        avatar_path = save_avatar(child.avatar, db_child.id)
        db_child.avatar = avatar_path
        db.commit()
    
    return db_child
```

#### PATCH /api/children/{child_id} - 更新小朋友信息
```python
@router.patch("/{child_id}", response_model=ChildResponse)
def update_child(
    child_id: int,
    child_update: ChildUpdate,
    db: Session = Depends(get_db)
):
    child = db.query(Child).filter(Child.id == child_id).first()
    if not child:
        raise HTTPException(status_code=404, detail="Child not found")
    
    # 更新字段
    for field, value in child_update.dict(exclude_unset=True).items():
        setattr(child, field, value)
    
    child.updated_at = datetime.utcnow()
    db.commit()
    db.refresh(child)
    return child
```

#### DELETE /api/children/{child_id} - 删除小朋友
```python
@router.delete("/{child_id}")
def delete_child(child_id: int, db: Session = Depends(get_db)):
    child = db.query(Child).filter(Child.id == child_id).first()
    if not child:
        raise HTTPException(status_code=404, detail="Child not found")
    
    # 级联删除相关记录
    db.delete(child)
    db.commit()
    return {"message": "Child deleted successfully"}
```

### 2. 星星操作接口

#### POST /api/children/{child_id}/stars/add - 增加星星
```python
@router.post("/{child_id}/stars/add")
def add_stars(
    child_id: int,
    star_data: AddStarsRequest,
    db: Session = Depends(get_db)
):
    # 开始事务
    try:
        # 1. 查找小朋友
        child = db.query(Child).filter(Child.id == child_id).first()
        if not child:
            raise HTTPException(status_code=404, detail="Child not found")
        
        # 2. 创建星星记录
        star_record = StarRecord(
            child_id=child_id,
            amount=star_data.amount,
            type=StarType.ADD,
            reason=star_data.reason
        )
        db.add(star_record)
        
        # 3. 更新小朋友的星星总数
        child.star_count += star_data.amount
        
        # 4. 提交事务
        db.commit()
        
        return {
            "message": "Stars added successfully",
            "new_total": child.star_count
        }
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))
```

#### POST /api/children/{child_id}/stars/subtract - 减少星星
```python
@router.post("/{child_id}/stars/subtract")
def subtract_stars(
    child_id: int,
    star_data: SubtractStarsRequest,
    db: Session = Depends(get_db)
):
    try:
        child = db.query(Child).filter(Child.id == child_id).first()
        if not child:
            raise HTTPException(status_code=404, detail="Child not found")
        
        # 检查余额
        if child.star_count < star_data.amount:
            raise HTTPException(
                status_code=400, 
                detail="Insufficient stars"
            )
        
        # 创建记录并更新余额
        star_record = StarRecord(
            child_id=child_id,
            amount=-star_data.amount,  # 负数表示减少
            type=StarType.SUBTRACT,
            reason=star_data.reason
        )
        db.add(star_record)
        child.star_count -= star_data.amount
        
        db.commit()
        return {
            "message": "Stars subtracted successfully",
            "new_total": child.star_count
        }
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))
```

### 3. 奖品管理接口

#### GET /api/rewards - 获取奖品列表
```python
@router.get("/", response_model=List[RewardResponse])
def get_rewards(
    child_id: Optional[int] = None,
    db: Session = Depends(get_db)
):
    query = db.query(Reward)
    
    # 按小朋友筛选
    if child_id:
        query = query.join(RewardChild).filter(
            RewardChild.child_id == child_id
        )
    
    rewards = query.all()
    
    # 计算每个奖品的进度
    for reward in rewards:
        reward.progress = calculate_progress(reward, db)
    
    return rewards
```

#### POST /api/rewards - 创建奖品
```python
@router.post("/", response_model=RewardResponse)
def create_reward(
    reward_data: RewardCreate,
    db: Session = Depends(get_db)
):
    # 创建奖品
    reward = Reward(
        name=reward_data.name,
        required_stars=reward_data.required_stars,
        description=reward_data.description
    )
    
    # 处理图片上传
    if reward_data.image:
        image_path = save_reward_image(reward_data.image)
        reward.image = image_path
    
    db.add(reward)
    db.flush()  # 获取ID但不提交
    
    # 关联小朋友
    for child_id in reward_data.child_ids:
        reward_child = RewardChild(
            reward_id=reward.id,
            child_id=child_id
        )
        db.add(reward_child)
    
    db.commit()
    db.refresh(reward)
    return reward
```

#### POST /api/rewards/{reward_id}/redeem - 兑换奖品
```python
@router.post("/{reward_id}/redeem")
def redeem_reward(
    reward_id: int,
    redeem_data: RedeemRequest,
    db: Session = Depends(get_db)
):
    # 使用事务确保数据一致性
    try:
        reward = db.query(Reward).filter(Reward.id == reward_id).first()
        if not reward:
            raise HTTPException(status_code=404, detail="Reward not found")
        
        if reward.is_redeemed:
            raise HTTPException(status_code=400, detail="Already redeemed")
        
        total_deduction = 0
        
        # 处理每个小朋友的扣除
        for deduction in redeem_data.deductions:
            child = db.query(Child).filter(
                Child.id == deduction.child_id
            ).first()
            
            if not child:
                raise HTTPException(
                    status_code=404, 
                    detail=f"Child {deduction.child_id} not found"
                )
            
            if child.star_count < deduction.amount:
                raise HTTPException(
                    status_code=400,
                    detail=f"{child.name} has insufficient stars"
                )
            
            # 创建兑换记录
            star_record = StarRecord(
                child_id=child.id,
                amount=-deduction.amount,
                type=StarType.REDEEM,
                reason=f"兑换奖品: {reward.name}",
                reward_id=reward_id
            )
            db.add(star_record)
            
            # 更新小朋友星星数
            child.star_count -= deduction.amount
            
            # 更新关联表中的扣除数量
            reward_child = db.query(RewardChild).filter(
                RewardChild.reward_id == reward_id,
                RewardChild.child_id == child.id
            ).first()
            if reward_child:
                reward_child.deduction_amount = deduction.amount
            
            total_deduction += deduction.amount
        
        # 标记奖品为已兑换
        reward.is_redeemed = True
        reward.redeemed_at = datetime.utcnow()
        
        db.commit()
        
        return {
            "message": "Reward redeemed successfully",
            "total_stars_deducted": total_deduction
        }
        
    except HTTPException:
        db.rollback()
        raise
    except Exception as e:
        db.rollback()
        logger.error(f"Redeem error: {str(e)}")
        raise HTTPException(status_code=500, detail="Redeem failed")
```

## 核心功能实现

### 1. 事务处理机制

所有涉及数据变更的操作都使用数据库事务，确保数据一致性：

```python
def transaction_wrapper(db: Session, operations: List[Callable]):
    """事务包装器"""
    try:
        for operation in operations:
            operation()
        db.commit()
        return {"success": True}
    except Exception as e:
        db.rollback()
        logger.error(f"Transaction failed: {str(e)}")
        raise HTTPException(status_code=500, detail="Operation failed")
```

### 2. 文件上传处理

#### 头像上传
```python
async def save_avatar(file: UploadFile, child_id: int) -> str:
    """保存头像文件"""
    # 验证文件类型
    if file.content_type not in ["image/jpeg", "image/png", "image/gif"]:
        raise HTTPException(status_code=400, detail="Invalid file type")
    
    # 生成文件名
    timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
    filename = f"avatar_{child_id}_{timestamp}.{file.filename.split('.')[-1]}"
    file_path = os.path.join(UPLOAD_DIR, "avatars", filename)
    
    # 保存文件
    os.makedirs(os.path.dirname(file_path), exist_ok=True)
    with open(file_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)
    
    # 生成缩略图
    create_thumbnail(file_path)
    
    return f"/uploads/avatars/{filename}"
```

### 3. 数据验证

使用Pydantic进行数据验证：

```python
class ChildCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    birthday: Optional[date] = None
    gender: Gender
    
    @validator('name')
    def validate_name(cls, v):
        if not v.strip():
            raise ValueError('Name cannot be empty')
        return v.strip()
    
    @validator('birthday')
    def validate_birthday(cls, v):
        if v and v > date.today():
            raise ValueError('Birthday cannot be in the future')
        return v
```

### 4. 错误处理

统一的错误处理机制：

```python
@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error": exc.detail,
            "status_code": exc.status_code,
            "timestamp": datetime.utcnow().isoformat()
        }
    )

@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=422,
        content={
            "error": "Validation Error",
            "details": exc.errors(),
            "timestamp": datetime.utcnow().isoformat()
        }
    )
```

### 5. 日志系统

配置日志记录：

```python
import logging
from logging.handlers import RotatingFileHandler

# 配置日志
logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)

# 文件处理器
file_handler = RotatingFileHandler(
    'logs/app.log',
    maxBytes=10485760,  # 10MB
    backupCount=5
)
file_handler.setFormatter(
    logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
)

# 控制台处理器
console_handler = logging.StreamHandler()
console_handler.setFormatter(
    logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
)

logger.addHandler(file_handler)
logger.addHandler(console_handler)
```

## 数据库操作

### 1. 连接管理

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# 创建数据库引擎
engine = create_engine(
    DATABASE_URL,
    pool_size=10,
    max_overflow=20,
    pool_pre_ping=True,  # 连接健康检查
    echo=DEBUG_MODE  # SQL日志
)

# 创建会话工厂
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# 依赖注入
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 2. 迁移管理

使用Alembic进行数据库迁移：

```bash
# 创建迁移
alembic revision --autogenerate -m "Add new field"

# 执行迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

### 3. 查询优化

```python
# 使用join减少查询次数
rewards_with_children = db.query(Reward)\
    .options(joinedload(Reward.children))\
    .all()

# 使用索引提升查询性能
class Child(Base):
    __tablename__ = "children"
    name = Column(String(100), index=True)
    created_at = Column(DateTime, index=True)

# 批量操作
db.bulk_insert_mappings(Child, [
    {"name": "Alice", "star_count": 10},
    {"name": "Bob", "star_count": 15}
])
db.commit()
```

## 安全性实现

### 1. CORS配置

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],  # 前端地址
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. 输入验证

- SQL注入防护（ORM自动处理）
- XSS防护（输出转义）
- 文件上传验证
- 请求大小限制

### 3. 环境变量管理

```python
from pydantic import BaseSettings

class Settings(BaseSettings):
    database_url: str
    secret_key: str
    debug: bool = False
    max_upload_size: int = 5 * 1024 * 1024  # 5MB
    
    class Config:
        env_file = ".env"

settings = Settings()
```

## 性能优化

### 1. 数据库优化
- 使用连接池
- 添加适当的索引
- 冗余字段（如star_count）
- 查询结果缓存

### 2. 异步处理
```python
@router.post("/async-operation")
async def async_operation(background_tasks: BackgroundTasks):
    background_tasks.add_task(process_heavy_task)
    return {"message": "Task started"}
```

### 3. 响应压缩
```python
from fastapi.middleware.gzip import GZipMiddleware
app.add_middleware(GZipMiddleware, minimum_size=1000)
```

## 测试策略

### 单元测试
```python
def test_create_child():
    response = client.post(
        "/api/children",
        json={"name": "Test Child", "gender": "boy"}
    )
    assert response.status_code == 200
    assert response.json()["name"] == "Test Child"
```

### 集成测试
```python
def test_redeem_flow():
    # 1. 创建小朋友
    # 2. 添加星星
    # 3. 创建奖品
    # 4. 执行兑换
    # 5. 验证结果
    pass
```

## 部署配置

### Docker配置
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 生产环境配置
- Gunicorn + Uvicorn workers
- Nginx反向代理
- SSL证书配置
- 日志收集
- 监控告警
